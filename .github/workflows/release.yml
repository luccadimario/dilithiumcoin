name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  # ── Node, CLI, Miner (cross-compiled, no CGO) ──
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25.x'

      - name: Extract version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF_NAME#v}" >> "$GITHUB_OUTPUT"

      - name: Cross-compile binaries
        run: |
          mkdir -p dist
          VERSION="${{ steps.version.outputs.VERSION }}"
          LDFLAGS="-X main.AppVersion=${VERSION}"

          platforms=(
            "linux/amd64"
            "linux/arm64"
            "darwin/amd64"
            "darwin/arm64"
            "windows/amd64"
          )

          binaries=(
            "dilithium:."
            "dilithium-cli:./cmd/dilithium-cli"
            "dilithium-miner:./cmd/dilithium-miner"
          )

          for binary in "${binaries[@]}"; do
            IFS=':' read -r name path <<< "$binary"
            for platform in "${platforms[@]}"; do
              IFS='/' read -r GOOS GOARCH <<< "$platform"
              output="dist/${name}-${GOOS}-${GOARCH}"
              if [ "$GOOS" = "windows" ]; then
                output="${output}.exe"
              fi
              echo "Building ${name} for ${GOOS}/${GOARCH}..."
              env CGO_ENABLED=0 GOOS="$GOOS" GOARCH="$GOARCH" go build \
                -ldflags "$LDFLAGS" \
                -o "$output" \
                "$path"
            done
          done

          # GPU miner has its own go.mod (self-contained for users to copy & build with CUDA)
          for platform in "${platforms[@]}"; do
            IFS='/' read -r GOOS GOARCH <<< "$platform"
            output="dist/dilithium-gpu-miner-${GOOS}-${GOARCH}"
            if [ "$GOOS" = "windows" ]; then
              output="${output}.exe"
            fi
            echo "Building dilithium-gpu-miner for ${GOOS}/${GOARCH}..."
            cd cmd/dilithium-gpu-miner
            env CGO_ENABLED=0 GOOS="$GOOS" GOARCH="$GOARCH" go build \
              -ldflags "$LDFLAGS" \
              -o "../../$output" \
              .
            cd ../..
          done

      - name: Generate checksums
        run: |
          cd dist
          sha256sum * > checksums-sha256.txt

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: core-binaries
          path: dist/*

  # ── Desktop GUI Apps (Wallet, Node, Miner — needs native UI libs per platform) ──
  gui-macos:
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25.x'

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Wails
        run: go install github.com/wailsapp/wails/v2/cmd/wails@latest

      - name: Build GUI apps
        run: |
          mkdir -p dist
          apps=(
            "dilithium-wallet:Dilithium-Wallet"
            "dilithium-node-gui:Dilithium-Node"
            "dilithium-miner-gui:Dilithium-Miner"
          )
          for app in "${apps[@]}"; do
            IFS=':' read -r dir name <<< "$app"
            echo "=== Building $name ==="
            cd cmd/$dir/frontend && npm install && cd ../../..
            cd cmd/$dir && wails build && cd ../..

            # Find .app bundle and create DMG
            APP_PATH=$(find cmd/$dir/build/bin -name "*.app" -type d | head -1)
            if [ -z "$APP_PATH" ]; then
              echo "ERROR: No .app bundle found for $dir"
              ls -la cmd/$dir/build/bin/
              exit 1
            fi
            echo "Found: $APP_PATH"

            rm -rf dmg-staging && mkdir dmg-staging
            cp -R "$APP_PATH" dmg-staging/
            ln -s /Applications dmg-staging/Applications
            hdiutil create -volname "$name" \
              -srcfolder dmg-staging \
              -ov -format UDZO \
              "dist/${name}-macOS.dmg"
          done

      - name: Upload macOS GUI apps
        uses: actions/upload-artifact@v4
        with:
          name: gui-macos
          path: dist/*-macOS.dmg

  gui-windows:
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25.x'

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Wails
        run: go install github.com/wailsapp/wails/v2/cmd/wails@latest

      - name: Install WebView2
        run: |
          Invoke-WebRequest -Uri "https://go.microsoft.com/fwlink/p/?LinkId=2124703" -OutFile "MicrosoftEdgeWebview2Setup.exe"
          Start-Process -FilePath "MicrosoftEdgeWebview2Setup.exe" -Args "/silent /install" -Wait

      - name: Build Wallet
        run: |
          cd cmd/dilithium-wallet/frontend && npm install && cd ../../..
          cd cmd/dilithium-wallet && wails build -nsis && cd ../..

      - name: Build Node GUI
        run: |
          cd cmd/dilithium-node-gui/frontend && npm install && cd ../../..
          cd cmd/dilithium-node-gui && wails build && cd ../..

      - name: Build Miner GUI
        run: |
          cd cmd/dilithium-miner-gui/frontend && npm install && cd ../../..
          cd cmd/dilithium-miner-gui && wails build && cd ../..

      - name: Copy artifacts
        run: |
          mkdir dist
          cp cmd/dilithium-wallet/build/bin/dilithium-wallet.exe dist/Dilithium-Wallet-Windows.exe
          if (Test-Path "cmd/dilithium-wallet/build/bin/dilithium-wallet-amd64-installer.exe") {
            cp cmd/dilithium-wallet/build/bin/dilithium-wallet-amd64-installer.exe dist/Dilithium-Wallet-Windows-Installer.exe
          }
          cp cmd/dilithium-node-gui/build/bin/dilithium-node-gui.exe dist/Dilithium-Node-Windows.exe
          cp cmd/dilithium-miner-gui/build/bin/dilithium-miner-gui.exe dist/Dilithium-Miner-Windows.exe

      - name: Upload Windows GUI apps
        uses: actions/upload-artifact@v4
        with:
          name: gui-windows
          path: dist/Dilithium-*-Windows*.exe

  gui-linux:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25.x'

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libgtk-3-dev libwebkit2gtk-4.0-dev

      - name: Install Wails
        run: go install github.com/wailsapp/wails/v2/cmd/wails@latest

      - name: Build GUI apps
        run: |
          mkdir -p dist
          apps=(
            "dilithium-wallet:Dilithium-Wallet"
            "dilithium-node-gui:Dilithium-Node"
            "dilithium-miner-gui:Dilithium-Miner"
          )
          for app in "${apps[@]}"; do
            IFS=':' read -r dir name <<< "$app"
            echo "=== Building $name ==="
            cd cmd/$dir/frontend && npm install && cd ../../..
            cd cmd/$dir && wails build && cd ../..
            cp cmd/$dir/build/bin/$dir dist/${name}-Linux-amd64
            chmod +x dist/${name}-Linux-amd64
          done

      - name: Upload Linux GUI apps
        uses: actions/upload-artifact@v4
        with:
          name: gui-linux
          path: dist/*-Linux-amd64

  # ── Collect all artifacts and publish GitHub Release ──
  publish:
    needs: [release, gui-macos, gui-windows, gui-linux]
    runs-on: ubuntu-latest
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Collect into dist
        run: |
          mkdir -p dist
          cp artifacts/core-binaries/* dist/
          cp artifacts/gui-macos/* dist/
          cp artifacts/gui-windows/* dist/
          cp artifacts/gui-linux/* dist/

          # Regenerate checksums with all files
          cd dist
          rm -f checksums-sha256.txt
          sha256sum * > checksums-sha256.txt

      - name: Create release
        uses: softprops/action-gh-release@v2
        with:
          name: Dilithium ${{ github.ref_name }}
          generate_release_notes: true
          files: |
            dist/*
          body: |
            ## Dilithium ${{ github.ref_name }}

            ### Desktop Apps (GUI)

            | App | macOS | Windows | Linux x86_64 |
            |-----|-------|---------|--------------|
            | Wallet | `Dilithium-Wallet-macOS.dmg` | `Dilithium-Wallet-Windows.exe` | `Dilithium-Wallet-Linux-amd64` |
            | Node Dashboard | `Dilithium-Node-macOS.dmg` | `Dilithium-Node-Windows.exe` | `Dilithium-Node-Linux-amd64` |
            | Miner | `Dilithium-Miner-macOS.dmg` | `Dilithium-Miner-Windows.exe` | `Dilithium-Miner-Linux-amd64` |

            > **Wallet** works standalone — no node required. It connects to the public Dilithium network automatically.
            > **Node Dashboard** connects to a local node's API to monitor peers, blocks, and mempool.
            > **Miner** mines blocks with a built-in multi-threaded SHA-256 PoW engine.

            ### CLI Binaries (Node / CLI / Miner / GPU Miner)

            | Platform | Node | CLI | Miner | GPU Miner |
            |----------|------|-----|-------|-----------|
            | Linux x86_64 | `dilithium-linux-amd64` | `dilithium-cli-linux-amd64` | `dilithium-miner-linux-amd64` | `dilithium-gpu-miner-linux-amd64` |
            | Linux ARM64 | `dilithium-linux-arm64` | `dilithium-cli-linux-arm64` | `dilithium-miner-linux-arm64` | `dilithium-gpu-miner-linux-arm64` |
            | macOS x86_64 | `dilithium-darwin-amd64` | `dilithium-cli-darwin-amd64` | `dilithium-miner-darwin-amd64` | `dilithium-gpu-miner-darwin-amd64` |
            | macOS ARM64 (Apple Silicon) | `dilithium-darwin-arm64` | `dilithium-cli-darwin-arm64` | `dilithium-miner-darwin-arm64` | `dilithium-gpu-miner-darwin-arm64` |
            | Windows x86_64 | `dilithium-windows-amd64.exe` | `dilithium-cli-windows-amd64.exe` | `dilithium-miner-windows-amd64.exe` | `dilithium-gpu-miner-windows-amd64.exe` |

            > **GPU Miner**: Pre-built binaries run in CPU mode. For NVIDIA GPU acceleration (~100x speedup), build locally with CUDA: `cd cmd/dilithium-gpu-miner && make gpu SM=86`

            ### Quick Start

            ```bash
            # Make binaries executable (macOS/Linux)
            chmod +x dilithium*

            # Create a wallet
            ./dilithium-cli wallet create

            # Start mining (auto-starts an embedded node)
            ./dilithium-miner --miner <your-address>

            # Or run node and miner separately
            ./dilithium --port 5001 --api-port 8001
            ./dilithium-miner --node http://localhost:8001 --miner <your-address>
            ```

            ### Verify Downloads

            SHA-256 checksums are available in `checksums-sha256.txt`.
