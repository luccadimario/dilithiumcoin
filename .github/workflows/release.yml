name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  # ── Node, CLI, Miner (cross-compiled, no CGO) ──
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25.x'

      - name: Extract version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF_NAME#v}" >> "$GITHUB_OUTPUT"

      - name: Cross-compile binaries
        run: |
          mkdir -p dist
          VERSION="${{ steps.version.outputs.VERSION }}"
          LDFLAGS="-X main.AppVersion=${VERSION}"

          platforms=(
            "linux/amd64"
            "linux/arm64"
            "darwin/amd64"
            "darwin/arm64"
            "windows/amd64"
          )

          binaries=(
            "dilithium:."
            "dilithium-cli:./cmd/dilithium-cli"
            "dilithium-miner:./cmd/dilithium-miner"
          )

          for binary in "${binaries[@]}"; do
            IFS=':' read -r name path <<< "$binary"
            for platform in "${platforms[@]}"; do
              IFS='/' read -r GOOS GOARCH <<< "$platform"
              output="dist/${name}-${GOOS}-${GOARCH}"
              if [ "$GOOS" = "windows" ]; then
                output="${output}.exe"
              fi
              echo "Building ${name} for ${GOOS}/${GOARCH}..."
              env CGO_ENABLED=0 GOOS="$GOOS" GOARCH="$GOARCH" go build \
                -ldflags "$LDFLAGS" \
                -o "$output" \
                "$path"
            done
          done

          # CPU/GPU miner (Go) has its own go.mod (self-contained for users to copy & build with CUDA)
          for platform in "${platforms[@]}"; do
            IFS='/' read -r GOOS GOARCH <<< "$platform"
            output="dist/dilithium-cpu-gpu-miner-${GOOS}-${GOARCH}"
            if [ "$GOOS" = "windows" ]; then
              output="${output}.exe"
            fi
            echo "Building dilithium-cpu-gpu-miner for ${GOOS}/${GOARCH}..."
            cd cmd/dilithium-cpu-gpu-miner
            env CGO_ENABLED=0 GOOS="$GOOS" GOARCH="$GOARCH" go build \
              -ldflags "$LDFLAGS" \
              -o "../../$output" \
              .
            cd ../..
          done

      - name: Generate checksums
        run: |
          cd dist
          sha256sum * > checksums-sha256.txt

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: core-binaries
          path: dist/*

  # ── Desktop Wallet (needs native UI libs per platform) ──
  gui-macos:
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25.x'

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Wails
        run: go install github.com/wailsapp/wails/v2/cmd/wails@latest

      - name: Build Wallet
        run: |
          mkdir -p dist
          cd cmd/dilithium-wallet/frontend && npm install && cd ../../..
          cd cmd/dilithium-wallet && wails build && cd ../..

          APP_PATH=$(find cmd/dilithium-wallet/build/bin -name "*.app" -type d | head -1)
          if [ -z "$APP_PATH" ]; then
            echo "ERROR: No .app bundle found"
            ls -la cmd/dilithium-wallet/build/bin/
            exit 1
          fi
          echo "Found: $APP_PATH"

          rm -rf dmg-staging && mkdir dmg-staging
          cp -R "$APP_PATH" dmg-staging/
          ln -s /Applications dmg-staging/Applications
          hdiutil create -volname "Dilithium-Wallet" \
            -srcfolder dmg-staging \
            -ov -format UDZO \
            "dist/Dilithium-Wallet-macOS.dmg"

      - name: Upload macOS Wallet
        uses: actions/upload-artifact@v4
        with:
          name: gui-macos
          path: dist/Dilithium-Wallet-macOS.dmg

  gui-windows:
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25.x'

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Wails
        run: go install github.com/wailsapp/wails/v2/cmd/wails@latest

      - name: Install WebView2
        run: |
          Invoke-WebRequest -Uri "https://go.microsoft.com/fwlink/p/?LinkId=2124703" -OutFile "MicrosoftEdgeWebview2Setup.exe"
          Start-Process -FilePath "MicrosoftEdgeWebview2Setup.exe" -Args "/silent /install" -Wait

      - name: Build Wallet
        run: |
          cd cmd/dilithium-wallet/frontend && npm install && cd ../../..
          cd cmd/dilithium-wallet && wails build -nsis && cd ../..

      - name: Copy artifacts
        run: |
          mkdir dist
          cp cmd/dilithium-wallet/build/bin/dilithium-wallet.exe dist/Dilithium-Wallet-Windows.exe
          if (Test-Path "cmd/dilithium-wallet/build/bin/dilithium-wallet-amd64-installer.exe") {
            cp cmd/dilithium-wallet/build/bin/dilithium-wallet-amd64-installer.exe dist/Dilithium-Wallet-Windows-Installer.exe
          }

      - name: Upload Windows Wallet
        uses: actions/upload-artifact@v4
        with:
          name: gui-windows
          path: dist/Dilithium-*-Windows*.exe

  gui-linux:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25.x'

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libgtk-3-dev libwebkit2gtk-4.0-dev

      - name: Install Wails
        run: go install github.com/wailsapp/wails/v2/cmd/wails@latest

      - name: Build Wallet
        run: |
          mkdir -p dist
          cd cmd/dilithium-wallet/frontend && npm install && cd ../../..
          cd cmd/dilithium-wallet && wails build && cd ../..
          cp cmd/dilithium-wallet/build/bin/dilithium-wallet dist/Dilithium-Wallet-Linux-amd64
          chmod +x dist/Dilithium-Wallet-Linux-amd64

      - name: Upload Linux Wallet
        uses: actions/upload-artifact@v4
        with:
          name: gui-linux
          path: dist/Dilithium-Wallet-Linux-amd64

  # ── Collect all artifacts and publish GitHub Release ──
  publish:
    needs: [release, gui-macos, gui-windows, gui-linux]
    runs-on: ubuntu-latest
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Collect into dist
        run: |
          mkdir -p dist
          cp artifacts/core-binaries/* dist/
          cp artifacts/gui-macos/* dist/
          cp artifacts/gui-windows/* dist/
          cp artifacts/gui-linux/* dist/

          # Regenerate checksums with all files
          cd dist
          rm -f checksums-sha256.txt
          sha256sum * > checksums-sha256.txt

      - name: Create release
        uses: softprops/action-gh-release@v2
        with:
          name: Dilithium ${{ github.ref_name }}
          generate_release_notes: true
          files: |
            dist/*
          body: |
            ## Dilithium ${{ github.ref_name }}

            ### Desktop Wallet (GUI)

            | macOS | Windows | Linux x86_64 |
            |-------|---------|--------------|
            | `Dilithium-Wallet-macOS.dmg` | `Dilithium-Wallet-Windows.exe` | `Dilithium-Wallet-Linux-amd64` |

            > **Wallet** works standalone — no node required. It connects to the public Dilithium network automatically.

            ### CLI Binaries (Node / CLI / Miner / CPU-GPU Miner)

            | Platform | Node | CLI | Miner | CPU/GPU Miner |
            |----------|------|-----|-------|---------------|
            | Linux x86_64 | `dilithium-linux-amd64` | `dilithium-cli-linux-amd64` | `dilithium-miner-linux-amd64` | `dilithium-cpu-gpu-miner-linux-amd64` |
            | Linux ARM64 | `dilithium-linux-arm64` | `dilithium-cli-linux-arm64` | `dilithium-miner-linux-arm64` | `dilithium-cpu-gpu-miner-linux-arm64` |
            | macOS x86_64 | `dilithium-darwin-amd64` | `dilithium-cli-darwin-amd64` | `dilithium-miner-darwin-amd64` | `dilithium-cpu-gpu-miner-darwin-amd64` |
            | macOS ARM64 (Apple Silicon) | `dilithium-darwin-arm64` | `dilithium-cli-darwin-arm64` | `dilithium-miner-darwin-arm64` | `dilithium-cpu-gpu-miner-darwin-arm64` |
            | Windows x86_64 | `dilithium-windows-amd64.exe` | `dilithium-cli-windows-amd64.exe` | `dilithium-miner-windows-amd64.exe` | `dilithium-cpu-gpu-miner-windows-amd64.exe` |

            > **GPU Miner (Rust+CUDA)**: For maximum GPU performance, build the Rust miner from `cmd/dilithium-gpu-miner/`.
            >
            > **CPU/GPU Miner (Go)**: Pre-built binaries run in CPU mode. For NVIDIA GPU acceleration (~100x speedup), build locally with CUDA: `cd cmd/dilithium-cpu-gpu-miner && make gpu SM=86`

            ### Quick Start

            ```bash
            # Make binaries executable (macOS/Linux)
            chmod +x dilithium*

            # Create a wallet
            ./dilithium-cli wallet create

            # Start mining (auto-starts an embedded node)
            ./dilithium-miner --miner <your-address>

            # Or run node and miner separately
            ./dilithium --port 5001 --api-port 8001
            ./dilithium-miner --node http://localhost:8001 --miner <your-address>
            ```

            ### Verify Downloads

            SHA-256 checksums are available in `checksums-sha256.txt`.
