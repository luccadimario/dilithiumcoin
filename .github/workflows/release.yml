name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  # ── Node, CLI, Miner (cross-compiled, no CGO) ──
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25.x'

      - name: Extract version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF_NAME#v}" >> "$GITHUB_OUTPUT"

      - name: Cross-compile binaries
        run: |
          mkdir -p dist
          VERSION="${{ steps.version.outputs.VERSION }}"
          LDFLAGS="-X main.AppVersion=${VERSION}"

          platforms=(
            "linux/amd64"
            "linux/arm64"
            "darwin/amd64"
            "darwin/arm64"
            "windows/amd64"
          )

          binaries=(
            "dilithium:."
            "dilithium-cli:./cmd/dilithium-cli"
            "dilithium-miner:./cmd/dilithium-miner"
          )

          for binary in "${binaries[@]}"; do
            IFS=':' read -r name path <<< "$binary"
            for platform in "${platforms[@]}"; do
              IFS='/' read -r GOOS GOARCH <<< "$platform"
              output="dist/${name}-${GOOS}-${GOARCH}"
              if [ "$GOOS" = "windows" ]; then
                output="${output}.exe"
              fi
              echo "Building ${name} for ${GOOS}/${GOARCH}..."
              env CGO_ENABLED=0 GOOS="$GOOS" GOARCH="$GOARCH" go build \
                -ldflags "$LDFLAGS" \
                -o "$output" \
                "$path"
            done
          done

      - name: Generate checksums
        run: |
          cd dist
          sha256sum * > checksums-sha256.txt

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: core-binaries
          path: dist/*

  # ── Wallet Desktop App (needs native UI libs per platform) ──
  wallet-macos:
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25.x'

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Wails
        run: go install github.com/wailsapp/wails/v2/cmd/wails@latest

      - name: Install frontend dependencies
        run: cd cmd/dilithium-wallet/frontend && npm install

      - name: Build wallet app
        run: |
          cd cmd/dilithium-wallet
          wails build

      - name: Find .app bundle and create DMG
        run: |
          mkdir -p dist

          # Find the .app bundle wherever Wails put it
          APP_PATH=$(find cmd/dilithium-wallet/build/bin -name "*.app" -type d | head -1)
          if [ -z "$APP_PATH" ]; then
            echo "ERROR: No .app bundle found. Contents of build/bin:"
            ls -la cmd/dilithium-wallet/build/bin/
            exit 1
          fi
          echo "Found app bundle: $APP_PATH"

          # Create a temporary directory for DMG contents
          mkdir -p dmg-staging
          cp -R "$APP_PATH" dmg-staging/
          ln -s /Applications dmg-staging/Applications

          # Create DMG
          hdiutil create -volname "Dilithium Wallet" \
            -srcfolder dmg-staging \
            -ov -format UDZO \
            "dist/Dilithium-Wallet-macOS.dmg"

      - name: Upload macOS wallet
        uses: actions/upload-artifact@v4
        with:
          name: wallet-macos
          path: dist/Dilithium-Wallet-macOS.dmg

  wallet-windows:
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25.x'

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Wails
        run: go install github.com/wailsapp/wails/v2/cmd/wails@latest

      - name: Install WebView2
        run: |
          Invoke-WebRequest -Uri "https://go.microsoft.com/fwlink/p/?LinkId=2124703" -OutFile "MicrosoftEdgeWebview2Setup.exe"
          Start-Process -FilePath "MicrosoftEdgeWebview2Setup.exe" -Args "/silent /install" -Wait

      - name: Install frontend dependencies
        run: cd cmd/dilithium-wallet/frontend && npm install

      - name: Build wallet app
        run: |
          cd cmd/dilithium-wallet
          wails build -nsis

      - name: Copy artifacts
        run: |
          mkdir dist
          cp cmd/dilithium-wallet/build/bin/dilithium-wallet.exe dist/Dilithium-Wallet-Windows.exe
          if (Test-Path "cmd/dilithium-wallet/build/bin/dilithium-wallet-amd64-installer.exe") {
            cp cmd/dilithium-wallet/build/bin/dilithium-wallet-amd64-installer.exe dist/Dilithium-Wallet-Windows-Installer.exe
          }

      - name: Upload Windows wallet
        uses: actions/upload-artifact@v4
        with:
          name: wallet-windows
          path: dist/Dilithium-Wallet-Windows*.exe

  wallet-linux:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25.x'

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libgtk-3-dev libwebkit2gtk-4.1-dev

      - name: Install Wails
        run: go install github.com/wailsapp/wails/v2/cmd/wails@latest

      - name: Install frontend dependencies
        run: cd cmd/dilithium-wallet/frontend && npm install

      - name: Build wallet app
        run: |
          cd cmd/dilithium-wallet
          wails build

      - name: Copy artifact
        run: |
          mkdir -p dist
          cp cmd/dilithium-wallet/build/bin/dilithium-wallet dist/Dilithium-Wallet-Linux-amd64
          chmod +x dist/Dilithium-Wallet-Linux-amd64

      - name: Upload Linux wallet
        uses: actions/upload-artifact@v4
        with:
          name: wallet-linux
          path: dist/Dilithium-Wallet-Linux-amd64

  # ── Collect all artifacts and publish GitHub Release ──
  publish:
    needs: [release, wallet-macos, wallet-windows, wallet-linux]
    runs-on: ubuntu-latest
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Collect into dist
        run: |
          mkdir -p dist
          cp artifacts/core-binaries/* dist/
          cp artifacts/wallet-macos/* dist/
          cp artifacts/wallet-windows/* dist/
          cp artifacts/wallet-linux/* dist/

          # Regenerate checksums with wallet files included
          cd dist
          rm -f checksums-sha256.txt
          sha256sum * > checksums-sha256.txt

      - name: Create release
        uses: softprops/action-gh-release@v2
        with:
          name: Dilithium ${{ github.ref_name }}
          generate_release_notes: true
          files: |
            dist/*
          body: |
            ## Dilithium ${{ github.ref_name }}

            ### Wallet (Desktop App)

            | Platform | Download |
            |----------|----------|
            | macOS (Universal) | `Dilithium-Wallet-macOS.dmg` |
            | Windows | `Dilithium-Wallet-Windows.exe` |
            | Linux x86_64 | `Dilithium-Wallet-Linux-amd64` |

            > The wallet works standalone — no node required. It connects to the public Dilithium network automatically.

            ### Node / CLI / Miner

            | Platform | Node | CLI | Miner |
            |----------|------|-----|-------|
            | Linux x86_64 | `dilithium-linux-amd64` | `dilithium-cli-linux-amd64` | `dilithium-miner-linux-amd64` |
            | Linux ARM64 | `dilithium-linux-arm64` | `dilithium-cli-linux-arm64` | `dilithium-miner-linux-arm64` |
            | macOS x86_64 | `dilithium-darwin-amd64` | `dilithium-cli-darwin-amd64` | `dilithium-miner-darwin-amd64` |
            | macOS ARM64 (Apple Silicon) | `dilithium-darwin-arm64` | `dilithium-cli-darwin-arm64` | `dilithium-miner-darwin-arm64` |
            | Windows x86_64 | `dilithium-windows-amd64.exe` | `dilithium-cli-windows-amd64.exe` | `dilithium-miner-windows-amd64.exe` |

            ### Quick Start

            ```bash
            # Make binaries executable (macOS/Linux)
            chmod +x dilithium*

            # Create a wallet
            ./dilithium-cli wallet create

            # Start mining (auto-starts an embedded node)
            ./dilithium-miner --miner <your-address>

            # Or run node and miner separately
            ./dilithium --port 5001 --api-port 8001
            ./dilithium-miner --node http://localhost:8001 --miner <your-address>
            ```

            ### Verify Downloads

            SHA-256 checksums are available in `checksums-sha256.txt`.
